name: Auto Format

on:
  push:
    branches: [ main ]
    paths:
      - '**.swift'
      - '.github/workflows/auto-format.yml'
      - 'Package.swift'

permissions:
  contents: write

jobs:
  format:
    name: Format and Lint
    runs-on: macos-latest # comes with brew pre-installed
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch full history for accurate git log dates
      
      - name: Apply SwiftLint
        run: |
          brew install swiftlint
          # Capture violations before fixing
          swiftlint lint Sources/ Tests/ --reporter json > swiftlint-before.json || true
          swiftlint --fix Sources/ Tests/
          echo "‚úÖ SwiftLint applied successfully"
          
      - name: Apply SwiftFormat
        run: |
          brew install swiftformat
          swiftformat Sources/ Tests/
          echo "‚úÖ SwiftFormat applied successfully"
      
      - name: Fix header dates
        run: |
          chmod +x .github/scripts/fix-header-dates.sh
          .github/scripts/fix-header-dates.sh
      
      - name: Analyze changes
        id: analysis
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No formatting changes needed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Get list of changed files
            git diff --name-only > changed-files.txt
            FILE_COUNT=$(wc -l < changed-files.txt | xargs)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            
            # Get diff stats
            INSERTIONS=$(git diff --shortstat | grep -o '[0-9]* insertion' | awk '{print $1}' || echo "0")
            DELETIONS=$(git diff --shortstat | grep -o '[0-9]* deletion' | awk '{print $1}' || echo "0")
            echo "insertions=$INSERTIONS" >> $GITHUB_OUTPUT
            echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
            
            # Parse SwiftLint violations
            if [ -f swiftlint-before.json ]; then
              cat > .github/scripts/parse_swiftlint.py << 'PYTHON_SCRIPT'
          import json
          import sys
          
          try:
              with open('swiftlint-before.json', 'r') as f:
                  violations = json.load(f)
              
              if not violations:
                  print("No SwiftLint violations detected")
                  sys.exit(0)
              
              # Group by rule
              by_rule = {}
              violation_details = []
              
              for v in violations:
                  rule = v.get('rule_id', 'unknown')
                  by_rule[rule] = by_rule.get(rule, 0) + 1
                  
                  file_path = v.get('file', '').replace('/Users/runner/work/swiftui-showcase/swiftui-showcase/', '')
                  line = v.get('line', '?')
                  severity = v.get('severity', 'warning')
                  reason = v.get('reason', 'No description')
                  
                  violation_details.append({
                      'file': file_path,
                      'line': line,
                      'rule': rule,
                      'severity': severity,
                      'reason': reason
                  })
              
              print(f"### üîß SwiftLint Fixes ({len(violations)} violations)\n")
              
              # Show top 10 violations with details
              print("| File:Line | Rule | Severity | Description |")
              print("|-----------|------|----------|-------------|")
              
              for v in violation_details[:10]:
                  severity_emoji = "‚ö†Ô∏è" if v['severity'] == 'warning' else "üö´"
                  rule_link = f"[`{v['rule']}`](https://realm.github.io/SwiftLint/rule-directory.html#{v['rule']})"
                  print(f"| `{v['file']}:{v['line']}` | {rule_link} | {severity_emoji} {v['severity']} | {v['reason'][:80]} |")
              
              if len(violation_details) > 10:
                  print(f"\n<details>")
                  print(f"<summary>üìã View all {len(violation_details)} SwiftLint fixes</summary>\n")
                  print("| File:Line | Rule | Severity | Description |")
                  print("|-----------|------|----------|-------------|")
                  for v in violation_details:
                      severity_emoji = "‚ö†Ô∏è" if v['severity'] == 'warning' else "üö´"
                      rule_link = f"[`{v['rule']}`](https://realm.github.io/SwiftLint/rule-directory.html#{v['rule']})"
                      print(f"| `{v['file']}:{v['line']}` | {rule_link} | {severity_emoji} {v['severity']} | {v['reason'][:80]} |")
                  print("\n</details>")
              
              # Rules summary
              print("\n### üìä Rules Summary\n")
              sorted_rules = sorted(by_rule.items(), key=lambda x: x[1], reverse=True)
              for rule, count in sorted_rules:
                  rule_link = f"[`{rule}`](https://realm.github.io/SwiftLint/rule-directory.html#{rule})"
                  print(f"- {rule_link}: **{count}** fix{'es' if count > 1 else ''}")
          
          except Exception as e:
              print(f"Error parsing SwiftLint output: {e}")
              print("No SwiftLint violations detected")
          PYTHON_SCRIPT
              
              python3 .github/scripts/parse_swiftlint.py > swiftlint-summary.md
            fi
            
            echo "‚úÖ Changes analyzed"
          fi
      
      - name: Commit and push changes
        if: steps.analysis.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Sources/ Tests/ Package.swift
          git commit -m "chore: apply SwiftLint & SwiftFormat [skip ci]"
          git push
      
      - name: Generate Summary
        if: always()
        run: |
          echo "## üé® Auto-Format Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.analysis.outputs.has_changes }}" == "true" ]; then
            echo "### üìä Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- üìù **Files Modified**: ${{ steps.analysis.outputs.file_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ûï **Lines Added**: ${{ steps.analysis.outputs.insertions }}" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ûñ **Lines Removed**: ${{ steps.analysis.outputs.deletions }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add SwiftLint summary if available
            if [ -f swiftlint-summary.md ]; then
              cat swiftlint-summary.md >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # List changed files
            echo "### üìÅ Files Modified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| File | Changes |" >> $GITHUB_STEP_SUMMARY
            echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
            git diff --numstat | while read additions deletions file; do
              echo "| \`$file\` | +$additions / -$deletions |" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add link to commit
            echo "### üîó Resources" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- üì¶ [View Commit](https://github.com/${{ github.repository }}/commit/\$(git rev-parse HEAD))" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add collapsible diff
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üìÑ Full Diff (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
            git diff --no-color | head -n 500 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **Formatting changes committed and pushed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **No formatting changes needed** - code is already perfectly formatted!" >> $GITHUB_STEP_SUMMARY
          fi
